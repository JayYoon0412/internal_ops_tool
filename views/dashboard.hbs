<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>대시보드</title>
    <link rel="icon" href="" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

</head>

<body class="sidebar-mini" style="height: auto;">
<div class="wrapper">

{{!-- 상단 전체 nav-bar --}}
<nav class="main-header navbar navbar-expand navbar-white navbar-light">

{{!-- 상단 좌측 링크 nav-bar --}}
<ul class="navbar-nav">
<li class="nav-item"><a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a></li>
<li class="nav-item d-none d-sm-inline-block"><a target="_blank" href="https://www.dealibird.com/pps/seller_issues/purchase_issues" class="nav-link">딜리버드</a></li>
<li class="nav-item d-none d-sm-inline-block"><a target="_blank" href="https://partners.kakaostyle.com/shop/cq-m2lp61rw/catalog/item_list" class="nav-link">KS파트너센터</a></li>
<li class="nav-item d-none d-sm-inline-block"><a target="_blank" href="https://cs.zigzag.kr/" class="nav-link">CS센터</a></li>
<li class="nav-item d-none d-sm-inline-block"><a target="_blank" href="https://backoffice.zigzag.kr/" class="nav-link">백오피스</a></li>

</ul>

{{!-- 상단 우측 알림 nav-bar --}}
<ul class="navbar-nav ml-auto">
{{!-- 상단 검색 --}}
<li class="nav-item">
<a class="nav-link" data-widget="navbar-search" href="#" role="button">
<i class="fas fa-search"></i>
</a>
<div class="navbar-search-block">
<form class="form-inline">
<div class="input-group input-group-sm">
<input class="form-control form-control-navbar" type="search" placeholder="Search" aria-label="Search">
<div class="input-group-append">
<button class="btn btn-navbar" type="submit">
<i class="fas fa-search"></i>
</button>
<button class="btn btn-navbar" type="button" data-widget="navbar-search">
<i class="fas fa-times"></i>
</button>
</div>
</div>
</form>
</div>
</li>
{{!-- 댓글 --}}
<li class="nav-item dropdown">
<a class="nav-link" data-toggle="dropdown" href="#">
<i class="far fa-comments"></i>
<span class="badge badge-danger navbar-badge">3</span>
</a>
<div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
</div>
</li>
{{!-- 알림 --}}
<li class="nav-item dropdown">
<a class="nav-link" data-toggle="dropdown" href="#">
<i class="far fa-bell"></i>
<span class="badge badge-warning navbar-badge">15</span>
</a>
<div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
</li>
{{!-- 위젯 --}}
<li class="nav-item">
<a class="nav-link" data-widget="control-sidebar" data-slide="true" href="#" role="button">
<i class="fas fa-th-large"></i>
</a>
</li>

</ul>
</nav>

{{!-- 좌측 전체 side-bar --}}
<aside class="main-sidebar sidebar-dark-primary elevation-4">

<a href="dashboard" class="brand-link">
    <span class="brand-text font-weight-light" style="margin-left: 10px;">직잭메이트 운영</span>
</a>

<div class="sidebar">
{{!-- 사용자 정보 --}}
<div class="user-panel mt-3 pb-3 mb-3 d-flex">
<div class="image">
    <i class="fas fa-user" style="color: #ffffff; margin-top: 10px"></i>
</div>
<div class="info">
<a href="/login" class="d-block">제이 (Jay)</a>
</div>
</div>

{{!-- 좌측 검색 --}}
<div class="form-inline">
    <div class="input-group" data-widget="sidebar-search">
    <input class="form-control form-control-sidebar" type="search" placeholder="Search" aria-label="Search">
    <div class="input-group-append">
    <button class="btn btn-sidebar">
    <i class="fas fa-search fa-fw"></i>
    </button>
    </div>
    </div><div class="sidebar-search-results"><div class="list-group"><a href="#" class="list-group-item"><div class="search-title"><strong class="text-light"></strong>N<strong class="text-light"></strong>o<strong class="text-light"></strong> <strong class="text-light"></strong>e<strong class="text-light"></strong>l<strong class="text-light"></strong>e<strong class="text-light"></strong>m<strong class="text-light"></strong>e<strong class="text-light"></strong>n<strong class="text-light"></strong>t<strong class="text-light"></strong> <strong class="text-light"></strong>f<strong class="text-light"></strong>o<strong class="text-light"></strong>u<strong class="text-light"></strong>n<strong class="text-light"></strong>d<strong class="text-light"></strong>!<strong class="text-light"></strong></div><div class="search-path"></div></a></div></div>
</div>

{{!-- 작업 패널 --}}
<nav class="mt-2">
<ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">

<li class="nav-item menu-open">
<a href="#" class="nav-link active">
<i class="nav-icon fas fa-tachometer-alt"></i>
<p>
    자동화 작업 <i class="right fas fa-angle-left"></i></p>
</a>

<ul class="nav nav-treeview">

    <li class="nav-item">
        <a href="https://dealibird.com/pps/seller_issues/purchase_issues" target="_blank" class="nav-link">
        <i class="far fa-circle nav-icon"></i>
        <p>입고 확인</p>
        </a>
    </li>

    <li class="nav-item">
        <a href="https://docs.google.com/spreadsheets/d/1yhuDkHz01LNLy3GUKDkkKSRPLbcKsohKTzEOLiMRWiw/edit#gid=1106539959" target="_blank" class="nav-link">
        <i class="far fa-circle nav-icon"></i>
        <p>반품 관리</p>
        </a>
    </li>

    <li class="nav-item">
        <a href="https://partners.kakaostyle.com/shop/cq-m2lp61rw/order_item/list/cancel" target="_blank" class="nav-link">
        <i class="far fa-circle nav-icon"></i>
        <p>취소 요청</p>
        </a>
    </li>

    <li class="nav-item">
        <a href="requestDelivery" class="nav-link">
        <i class="far fa-circle nav-icon"></i>
        <p>출고 요청</p>
        </a>
    </li>

    <li class="nav-item">
        <a href="https://docs.google.com/spreadsheets/d/1yhuDkHz01LNLy3GUKDkkKSRPLbcKsohKTzEOLiMRWiw/edit#gid=550784532" target="_blank" class="nav-link">
        <i class="far fa-circle nav-icon"></i>
        <p>품절 관리</p>
        </a>
    </li>

    <li class="nav-item">
        <a class="nav-link" id="cancelAllButton">
        <i class="far fa-circle nav-icon"></i>
        <p>전체 취소</p>
        </a>
        <form id="cancelAllForm" action="/upload" method="post" enctype="multipart/form-data" style="display:none">
                <input class="btn btn-sidebar" type="file" name="file" accept=".xlsx" style="font-size: x-small; width:180px"/>
                <button type="submit" class="btn btn-sidebar" id="submitCancel" style="display: inline;font-size:14px">확인</button>
        </form>
    </li>

</ul>
</li>
</nav>

</div>

</aside>

{{!-- 중간 카드모음 내용 --}}
<div class="content-wrapper" style="min-height: 1302.26px;">

<div class="content-header">
<div class="container-fluid">
<div class="row mb-2">
<div class="col-sm-6">
<h1 class="m-0">Dashboard</h1>
</div>
<div class="col-sm-6">
<ol class="breadcrumb float-sm-right">
<li class="breadcrumb-item"><a href="#">Home</a></li>
<li class="breadcrumb-item active">Dashboard</li>
</ol>
</div>
</div>
</div>
</div>


<div class="content">
<div class="container-fluid">
<div class="row">
<div class="col-lg-6">
{{!-- 셀러 입점 패널 --}}
<div class="card">
<div class="card-header border-0">
<div class="d-flex justify-content-between">
<h3 class="card-title">셀러 입점 현황</h3>
<a href="https://docs.google.com/spreadsheets/d/1tS28m18rIWO_2JEE6r0aPI8hfzJXSam44yp4_ZHedTQ/edit#gid=524674474" target="_blank">전체 인바운드 셀러 상세 시트 보기</a>
</div>
</div>
<div class="card-body">
<div class="d-flex">
<p class="d-flex flex-column">
<span class="text-bold text-lg" id="sellerCount"></span>
<span>입점 셀러 수</span>
</p>
<p class="ml-auto d-flex flex-column text-right">
<span class="text-success">
<i class="fas fa-arrow-up"></i> 12.5%
</span>
<span class="text-muted">지난 주 기준</span>
</p>
</div>

<div class="position-relative mb-4"><div class="chartjs-size-monitor"><div class="chartjs-size-monitor-expand"><div class=""></div></div><div class="chartjs-size-monitor-shrink"><div class=""></div></div></div>
<canvas id="lineChart"></canvas>
</div>
<div class="d-flex flex-row justify-content-end">
<span class="mr-2">
<i class="fas fa-square text-primary"></i> 이번주
</span>
<span>
<i class="fas fa-square text-gray"></i> 지난주
</span>
</div>
</div>
</div>

{{!-- 운영 지표 패널 --}}
<div class="card">
<div class="card-header border-0">
<h3 class="card-title"><span id="todaysDate"></span></h3>
<div class="card-tools">
<a href="#" class="btn btn-tool btn-sm">
<i class="fas fa-download"></i>
</a>
<a href="#" class="btn btn-tool btn-sm">
<i class="fas fa-bars"></i>
</a>
</div>
</div>
<div class="card-body table-responsive p-0">
<table class="table table-striped table-valign-middle">
<thead>
<tr>
<th>작업</th>
<th>건수</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>
금일 추가 입점
</td>

<td>
{{!-- <small class="text-success mr-1"><i class="fas fa-arrow-up"></i>12%</small> --}}
<input type="number" id="newSellerCount" style="width: 100px;"/>
</td>
<td></td>
</tr>
<tr>
<td>
입고 확인
</td>

<td>
{{!-- <small class="text-warning mr-1"><i class="fas fa-arrow-down"></i>5%</small> --}}
<input type="number" id="checkCount" style="width: 100px;"/>
</td>
<td></td>
</tr>

<tr>
<td>
반품 처리
</td>

<td>
{{!-- <small class="text-danger mr-1"><i class="fas fa-arrow-down"></i>3%</small> --}}
<input type="number" id="returnCount" style="width: 100px;"/>
</td>
<td></td>
</tr>

<tr>
<td>
품절 상품
{{!-- <span class="badge bg-danger">NEW</span> --}}
</td>

<td>
{{!-- <small class="text-danger mr-1"><i class="fas fa-arrow-up"></i>63%</small> --}}
<input type="number" id="oosCount" style="width: 100px;"/>
</td>
<td></td>
</tr>
<tr>
<td>
부분 출고
</td>
<td><input type="number" id="partialOBCount" style="width: 100px"/></td>
<td></td>
</tr>

<tr>
<td>
전체 출고  
</td>
<td><input type="number" id="totalOBCount" style="width: 100px"/></td>
<td></td>
</tr>

<tr>
<td>
사용자 취소 주문
</td>
<td><input type="number" id="userCancelCount" style="width: 100px"/></td>
<td></td>
</tr>

<tr>
<td>
품절 취소 주문
</td>
<td><input type="number" id="oosCancelCount" style="width: 100px;"/></td>
<td><button id="updateSheetButton" class="btn btn-navBar" style="border: 1px solid grey; padding:5px 10px 5px 10px; display:flex; margin-left:auto">시트 업데이트</button></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

{{!-- 콘솔 패널 --}}
<div class="col-lg-6">
<div class="card" style="min-height:892px; max-height:1115px; overflow-y:auto">
<div class="card-header border-0">
<div class="d-flex justify-content-between">
<h3 class="card-title">툴 로그 콘솔</h3>
<a href="javascript:void(0);">전체 파일 다운로드</a>
</div>
</div>
<div class="card-body" id="messageList"></div>
</div>
</div>
</div>
</div>
</div>
</div>

{{!-- 하단 푸터 정보 --}}
<footer class="main-footer">
<strong>Copyright © 2023</strong>
All rights reserved.
<div class="float-right d-none d-sm-inline-block">
<b>Version</b> 1.0.0
</div>
</footer>

</body>

<script>
    const socket = new WebSocket('ws://localhost:8080');
    socket.onopen = function() {console.log("SUCCESS CONNECT SOCKET ON BROWSER!")}
    socket.onmessage = function(event) {
        const data = event.data;
        try {
            const jsonData = JSON.parse(data);
            console.log(jsonData);
            appendMessageToList(jsonData);
        } catch (error) {
            console.error('Error parsing JSON:', error);
        }
    }

    function appendMessageToList(message) {
        const logList = document.getElementById('messageList');
        const logItem = document.createElement('p');
        logItem.style.marginBottom = '0px';
        logItem.style.color = 'grey';
        logItem.textContent = `[${message.timestamp}] ${message.level}: ${message.message} ${message.ms}`;
        logList.appendChild(logItem);
    }

    const today = new Date();
    document.getElementById('todaysDate').textContent = today;

    document.addEventListener('DOMContentLoaded', function() {
        const cancelAllButton = document.getElementById('cancelAllButton');
        const cancelAllForm = document.getElementById('cancelAllForm');
        cancelAllButton.addEventListener('click', function() {
            cancelAllForm.style.display = 'block';
        });
    });

    document.addEventListener('DOMContentLoaded', async function() {
        const res = await fetch('/sheetLoad', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        const data = await res.json();
        document.getElementById('sellerCount').textContent = data.totalCount;
        const labelArr = data.dateLabels
        const valueArr = data.sellerIncValues

        const lineChartData = {
            labels: labelArr,
            datasets: [{
                label: "일별 셀러 입점 건수",
                borderColor: "rgba(75, 192, 192, 1)",
                borderWidth: 2,
                fill: false,
                data: valueArr
            }],
        };
        const lineCanvas = document.getElementById("lineChart").getContext("2d");

        new Chart(lineCanvas, {
            type: "line",
            data: lineChartData,
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                    },
                },
            },
        });
    })

    document.getElementById("updateSheetButton").addEventListener("click", async () => {
        const inputIds = ["newSellerCount","checkCount","returnCount","oosCount","partialOBCount","totalOBCount","userCancelCount","oosCancelCount"];
        const values = {};
        inputIds.forEach((id) => {
            values[id] = document.getElementById(id).value;
        });
        const dateTime = new Date();
        const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
        const fDate = dateTime.toLocaleDateString('en-US', options);
        console.log(fDate)
        const dateStr = fDate.toString();

        const argsDto = {
            seller: values["newSellerCount"],
            check: values["checkCount"],
            returns: values["returnCount"],
            oos: values["oosCount"],
            partialOB: values["partialOBCount"],
            totalOB: values["totalOBCount"],
            userCancel: values["userCancelCount"],
            oosCancel: values["oosCancelCount"],
            date: dateStr
        }

        await fetch('/updateSheet', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(argsDto)
        });
        inputIds.forEach((id) => {
            document.getElementById(id).value = "";
        })

    })
</script>

</html>